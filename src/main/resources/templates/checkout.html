<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{base}">
<head>
    <title>Checkout</title>
    <script src="https://js.stripe.com/v3/"></script>
</head>
<div id="dbg" th:text="${reservation.id}"></div>
<section layout:fragment="content">
    <div class="container d-flex justify-content-center align-items-center" style="min-height: 80vh;">
        <div class="card shadow-sm border rounded-4 p-4"
             style="background-color: #fdfdfd; max-width: 600px; width: 100%;">

            <h3 class="mb-4 text-center fw-bold text-dark">Complete Payment</h3>

            <div class="mb-2 text-secondary">
                <strong class="text-dark">Reservation:</strong>
                <span th:text="${reservation.id}"></span>
            </div>

            <div class="mb-4 text-secondary">
                <strong class="text-dark">Total:</strong>
                <span th:text="${reservation.totalPrice}"></span> CAD
            </div>

            <div id="payment-element" class="mb-3"></div>

            <button id="submit" class="btn btn-primary w-100">
                <span class="btn-text">Pay now</span>
                <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true"></span>
            </button>

            <div id="message" class="mt-3 text-danger" role="alert"></div>
        </div>
    </div>

    <script th:inline="javascript">
        const reservationId = /*[[${reservation.id}]]*/ 0;
        let stripe, elements, paymentElement, pollTimer;

        function setLoading(isLoading) {
            const btn = document.getElementById("submit");
            const spinner = btn.querySelector(".spinner-border");
            const text = btn.querySelector(".btn-text");
            btn.disabled = isLoading;
            spinner.classList.toggle("d-none", !isLoading);
            text.textContent = isLoading ? "Processing..." : "Pay now";
        }

        function setPayEnabled(enabled, msg) {
            const btn = document.getElementById("submit");
            btn.disabled = !enabled;
            const m = document.getElementById("message");
            if (msg) m.textContent = msg; else m.textContent = "";
        }

        async function init() {
            setLoading(true);

            console.log("reservationId =", reservationId);

            let resp;
            try {
                resp = await fetch("/api/payments/create-intent", {
                    method: "POST",
                    headers: {"Content-Type": "application/x-www-form-urlencoded"},
                    body: new URLSearchParams({reservationId})
                });
            } catch {
                document.getElementById("message").textContent = "Network error while starting payment.";
                setLoading(false);
                return;
            }
            if (!resp.ok) {
                document.getElementById("message").textContent = "Unable to start payment.";
                setLoading(false);
                return;
            }

            const data = await resp.json();
            stripe = Stripe(data.publishableKey);
            elements = stripe.elements({clientSecret: data.clientSecret});

            paymentElement = elements.create("payment");
            paymentElement.mount("#payment-element");

            // First hold check right away
            await refreshHoldValidity();

            setLoading(false);
            document.getElementById("submit").addEventListener("click", onSubmit);

            // Optional: poll every 10s to live-disable the button when hold expires
            clearInterval(pollTimer);
            pollTimer = setInterval(refreshHoldValidity, 10_000);
        }

        async function refreshHoldValidity() {
            try {
                const url = `/api/reservations/${reservationId}/hold`;
                const res = await fetch(url, {method: "GET", cache: "no-store", credentials: "same-origin"});
                if (!res.ok) throw new Error("Hold check failed: " + res.status);
                const payload = await res.json();
                console.log("hold check payload:", payload);

                if (!payload.valid) {
                    const msg = payload.status === "CANCELLED"
                        ? "Your hold expired and was cancelled. Please restart checkout."
                        : "Your hold is no longer valid. Please restart checkout.";
                    setPayEnabled(false, msg);
                    return false;
                } else {
                    setPayEnabled(true, "");
                    return true;
                }
            } catch (e) {
                console.error(e);
                setPayEnabled(false, "Could not verify your reservation hold. Please refresh and try again.");
                return false;
            }
        }

        async function onSubmit() {
            setLoading(true);

            // Hard guard before confirming payment
            const stillValid = await refreshHoldValidity();
            if (!stillValid) {
                setLoading(false);
                return;
            }

            if (!stripe || !elements) {
                document.getElementById("message").textContent = "Payment not initialized yet. Please wait and try again.";
                setLoading(false);
                return;
            }

            const {error} = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: window.location.origin + "/payment/confirm?reservationId=" + reservationId
                }
            });

            if (error) {
                document.getElementById("message").textContent = error.message || "Payment failed.";
                setLoading(false);
            }
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
</section>
</html>